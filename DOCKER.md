# Docker: Caddy (TLS) + Django (Gunicorn)

## Prerequisites
- Docker 24+
- Docker Compose v2

## Files
- Dockerfile: Multi-stage image for Django + Gunicorn
- docker-compose.yml: `app` and `caddy` services
- caddy/Caddyfile: Reverse proxy, static/media, admin API
- entrypoint.sh: migrate + collectstatic + start gunicorn

## Quick Start (dev)
```bash
# From repo root
# Optionally create env/.env (compose references it). Example values:
mkdir -p env && cat > env/.env <<'ENV'
DJANGO_SETTINGS_MODULE=waf_app.settings
SECRET_KEY=dev-secret
DEBUG=1
ALLOWED_HOSTS=*
GUNICORN_WORKERS=3
ENV

# Build and run
docker compose up -d --build

# View logs
docker compose logs -f app
docker compose logs -f caddy

# Open app
# http://localhost (Caddy proxies to app:8000)
```

## Volumes
- caddy_data: ACME/certs state (persist)
- caddy_config: Caddy config/state
- app_static: Django collected static (`/app/staticfiles`)
- app_media: Django media (`/app/media`)

## Static & Media
- `entrypoint.sh` runs `collectstatic` into `/app/staticfiles`
- Caddy serves `/static/*` from `/srv/static` (mapped from `app_static`)
- Caddy serves `/media/*` from `/srv/media` (mapped from `app_media`)

## Caddy Admin API
- Exposed on `:2019` (mapped). Adjust or restrict in production.

## Production Notes
- Set real domain and let Caddy obtain certs via ACME (site configs under `caddy/sites/` or generated by app)
- Set `DEBUG=0` and secure Django settings
- Use a proper database (Postgres) and configure `DATABASE_URL`
- Backup `caddy_data` and media volumes

## Troubleshooting
- If app fails on migrations: inspect `docker compose logs app`
- If static missing: ensure `collectstatic` ran and volume mounted
- Caddy 502: verify `app` container health and network connectivity
