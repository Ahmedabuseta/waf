{% load static %}
<!doctype html>
<html lang="en" class="dark">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Analytics Dashboard - WAF</title>

        <!-- Tailwind CSS -->
        <script src="https://cdn.tailwindcss.com"></script>

        <!-- Flowbite -->
        <link
            href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css"
            rel="stylesheet"
        />

        <!-- Leaflet CSS for Map -->
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        />

        <!-- Chart.js -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

        <style>
            #map {
                height: 500px;
                border-radius: 0.5rem;
            }
        </style>
    </head>
    <body class="bg-gray-900">
        <!-- Navigation Bar -->
        <nav class="bg-gray-800 border-b border-gray-700">
            <div
                class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4"
            >
                <a
                    href="/"
                    class="flex items-center space-x-3 rtl:space-x-reverse"
                >
                    <svg
                        class="w-8 h-8 text-blue-500"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"
                        ></path>
                    </svg>
                    <span
                        class="self-center text-2xl font-semibold whitespace-nowrap dark:text-white"
                        >WAF Analytics</span
                    >
                </a>
                <div class="flex items-center space-x-4">
                    <button
                        id="theme-toggle"
                        type="button"
                        class="text-gray-400 hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-700 rounded-lg text-sm p-2.5"
                    >
                        <svg
                            id="theme-toggle-dark-icon"
                            class="w-5 h-5"
                            fill="currentColor"
                            viewBox="0 0 20 20"
                        >
                            <path
                                d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
                            ></path>
                        </svg>
                    </button>
                </div>
            </div>
        </nav>

        <div class="max-w-screen-xl mx-auto p-4">
            {% if error %}
            <div
                class="p-4 mb-4 text-sm text-red-800 rounded-lg bg-red-50 dark:bg-gray-800 dark:text-red-400"
                role="alert"
            >
                {{ error }}
            </div>
            {% else %}

            <!-- Header with Site Selector and Time Range -->
            <div
                class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4"
            >
                <div>
                    <h1 class="text-3xl font-bold dark:text-white mb-2">
                        Analytics Dashboard
                    </h1>
                    <p class="text-gray-400">
                        Geographic request analytics and threat monitoring
                    </p>
                </div>

                <div class="flex gap-3">
                    <!-- Site Selector -->
                    <select
                        id="site-selector"
                        class="bg-gray-700 border border-gray-600 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5"
                    >
                        {% for site in sites %}
                        <option
                            value="{{ site.slug }}"
                            {%
                            if
                            site=""
                            ="current_site"
                            %}selected{%
                            endif
                            %}
                        >
                            {{ site.host }}
                        </option>
                        {% endfor %}
                    </select>

                    <!-- Time Range Selector -->
                    <select
                        id="time-range"
                        class="bg-gray-700 border border-gray-600 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5"
                    >
                        <option
                            value="1"
                            {%
                            if
                            days=""
                            ="1"
                            %}selected{%
                            endif
                            %}
                        >
                            Last 24 Hours
                        </option>
                        <option
                            value="7"
                            {%
                            if
                            days=""
                            ="7"
                            %}selected{%
                            endif
                            %}
                        >
                            Last 7 Days
                        </option>
                        <option
                            value="30"
                            {%
                            if
                            days=""
                            ="30"
                            %}selected{%
                            endif
                            %}
                        >
                            Last 30 Days
                        </option>
                        <option
                            value="90"
                            {%
                            if
                            days=""
                            ="90"
                            %}selected{%
                            endif
                            %}
                        >
                            Last 90 Days
                        </option>
                    </select>

                    <!-- Export Dropdown -->
                    <button
                        id="dropdownExportButton"
                        data-dropdown-toggle="dropdownExport"
                        class="dark:text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center inline-flex items-center"
                        type="button"
                    >
                        Export
                        <svg
                            class="w-2.5 h-2.5 ms-3"
                            aria-hidden="true"
                            xmlns="http://www.w3.org/2000/svg"
                            fill="none"
                            viewBox="0 0 10 6"
                        >
                            <path
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="m1 1 4 4 4-4"
                            />
                        </svg>
                    </button>
                    <div
                        id="dropdownExport"
                        class="z-10 hidden bg-gray-700 divide-y divide-gray-600 rounded-lg shadow w-44"
                    >
                        <ul
                            class="py-2 text-sm text-gray-200"
                            aria-labelledby="dropdownExportButton"
                        >
                            <li>
                                <a
                                    href="{% url 'export_csv' current_site.slug %}?days={{ days }}"
                                    class="block px-4 py-2 hover:bg-gray-600"
                                    >Export CSV</a
                                >
                            </li>
                            <li>
                                <a
                                    href="{% url 'export_json' current_site.slug %}?days={{ days }}"
                                    class="block px-4 py-2 hover:bg-gray-600"
                                    >Export JSON</a
                                >
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Key Metrics Cards -->
            <div
                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6"
            >
                <!-- Total Requests -->
                <div class="bg-gray-800 border border-gray-700 rounded-lg p-5">
                    <div class="flex items-center justify-between mb-2">
                        <h5 class="text-sm font-medium text-gray-400">
                            Total Requests
                        </h5>
                        <svg
                            class="w-5 h-5 text-blue-500"
                            fill="currentColor"
                            viewBox="0 0 20 20"
                        >
                            <path
                                d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"
                            ></path>
                        </svg>
                    </div>
                    <p class="text-3xl font-bold dark:text-white">
                        {{ total_requests|default:"0" }}
                    </p>
                </div>

                <!-- Blocked Requests -->
                <div class="bg-gray-800 border border-gray-700 rounded-lg p-5">
                    <div class="flex items-center justify-between mb-2">
                        <h5 class="text-sm font-medium text-gray-400">
                            Blocked
                        </h5>
                        <svg
                            class="w-5 h-5 text-red-500"
                            fill="currentColor"
                            viewBox="0 0 20 20"
                        >
                            <path
                                fill-rule="evenodd"
                                d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z"
                                clip-rule="evenodd"
                            ></path>
                        </svg>
                    </div>
                    <p class="text-3xl font-bold dark:text-white">
                        {{ blocked_requests|default:"0" }}
                    </p>
                    <p class="text-sm text-gray-400">
                        {{ blocked_percentage|floatformat:1 }}%
                    </p>
                </div>

                <!-- Unique Countries -->
                <div class="bg-gray-800 border border-gray-700 rounded-lg p-5">
                    <div class="flex items-center justify-between mb-2">
                        <h5 class="text-sm font-medium text-gray-400">
                            Countries
                        </h5>
                        <svg
                            class="w-5 h-5 text-green-500"
                            fill="currentColor"
                            viewBox="0 0 20 20"
                        >
                            <path
                                fill-rule="evenodd"
                                d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.73 6.974 6 7.5 6A1.5 1.5 0 019 7.5V8a2 2 0 004 0 2 2 0 011.523-1.943A5.977 5.977 0 0116 10c0 .34-.028.675-.083 1H15a2 2 0 00-2 2v2.197A5.973 5.973 0 0110 16v-2a2 2 0 00-2-2 2 2 0 01-2-2 2 2 0 00-1.668-1.973z"
                                clip-rule="evenodd"
                            ></path>
                        </svg>
                    </div>
                    <p class="text-3xl font-bold dark:text-white">
                        {{ unique_countries|default:"0" }}
                    </p>
                </div>

                <!-- Unique IPs -->
                <div class="bg-gray-800 border border-gray-700 rounded-lg p-5">
                    <div class="flex items-center justify-between mb-2">
                        <h5 class="text-sm font-medium text-gray-400">
                            Unique IPs
                        </h5>
                        <svg
                            class="w-5 h-5 text-yellow-500"
                            fill="currentColor"
                            viewBox="0 0 20 20"
                        >
                            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path>
                            <path
                                fill-rule="evenodd"
                                d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z"
                                clip-rule="evenodd"
                            ></path>
                        </svg>
                    </div>
                    <p class="text-3xl font-bold dark:text-white">
                        {{ unique_ips|default:"0" }}
                    </p>
                </div>

                <!-- Avg Response Time -->
                <div class="bg-gray-800 border border-gray-700 rounded-lg p-5">
                    <div class="flex items-center justify-between mb-2">
                        <h5 class="text-sm font-medium text-gray-400">
                            Avg Response
                        </h5>
                        <svg
                            class="w-5 h-5 text-purple-500"
                            fill="currentColor"
                            viewBox="0 0 20 20"
                        >
                            <path
                                fill-rule="evenodd"
                                d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"
                                clip-rule="evenodd"
                            ></path>
                        </svg>
                    </div>
                    <p class="text-3xl font-bold dark:text-white">
                        {{ avg_response_time|default:"0" }}
                    </p>
                    <p class="text-sm text-gray-400">ms</p>
                </div>
            </div>

            <!-- Threat Alerts -->
            {% if recent_alerts %}
            <div class="mb-6 bg-gray-800 border border-gray-700 rounded-lg p-5">
                <h3
                    class="text-lg font-semibold dark:text-white mb-4 flex items-center"
                >
                    <svg
                        class="w-5 h-5 mr-2 text-red-500"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                    >
                        <path
                            fill-rule="evenodd"
                            d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                            clip-rule="evenodd"
                        ></path>
                    </svg>
                    Active Threat Alerts
                </h3>
                <div class="space-y-2">
                    {% for alert in recent_alerts %}
                    <div
                        class="flex items-center justify-between p-3 bg-gray-700 rounded-lg"
                    >
                        <div class="flex items-center gap-3">
                            <span
                                class="px-2 py-1 text-xs font-medium rounded {% if alert.severity == 'critical' %}bg-red-900 text-red-300 {% elif alert.severity == 'high' %}bg-orange-900 text-orange-300 {% else %}bg-yellow-900 text-yellow-300{% endif %}"
                            >
                                {{ alert.severity|upper }}
                            </span>
                            <span class="dark:text-white"
                                >{{ alert.get_alert_type_display }}</span
                            >
                            {% if alert.ip_address %}
                            <span class="text-gray-400"
                                >{{ alert.ip_address }}</span
                            >
                            {% endif %} {% if alert.country_code %}
                            <span class="text-gray-400"
                                >{{ alert.country_code }}</span
                            >
                            {% endif %}
                        </div>
                        <span class="text-sm text-gray-400"
                            >{{ alert.timestamp|timesince }} ago</span
                        >
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Main Content: Map and Geographic Table -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <!-- 2D World Map -->
                <div
                    class="lg:col-span-2 bg-gray-800 border border-gray-700 rounded-lg p-5"
                >
                    <h3 class="text-lg font-semibold dark:text-white mb-4">
                        Geographic Distribution
                    </h3>
                    <div id="map"></div>
                </div>

                <!-- Geographic Breakdown Table -->
                <div class="bg-gray-800 border border-gray-700 rounded-lg p-5">
                    <h3 class="text-lg font-semibold dark:text-white mb-4">
                        Top Locations
                    </h3>
                    <div class="overflow-auto" style="max-height: 500px">
                        <table
                            id="geo-table"
                            class="w-full text-sm text-left text-gray-400"
                        >
                            <thead
                                class="text-xs uppercase bg-gray-700 text-gray-400 sticky top-0"
                            >
                                <tr>
                                    <th class="px-3 py-2">Location</th>
                                    <th class="px-3 py-2 text-right">
                                        Requests
                                    </th>
                                    <th class="px-3 py-2 text-right">
                                        Blocked
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="geo-table-body">
                                <tr>
                                    <td
                                        colspan="3"
                                        class="px-3 py-4 text-center"
                                    >
                                        Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Timeline Chart -->
            <div class="mb-6 bg-gray-800 border border-gray-700 rounded-lg p-5">
                <h3 class="text-lg font-semibold dark:text-white mb-4">
                    Requests Over Time
                </h3>
                <canvas id="timeline-chart" height="80"></canvas>
            </div>

            <!-- Bottom Row: Top IPs and Request Methods -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Top IPs -->
                <div class="bg-gray-800 border border-gray-700 rounded-lg p-5">
                    <h3 class="text-lg font-semibold dark:text-white mb-4">
                        Top Requesting IPs
                    </h3>
                    <div class="overflow-auto" style="max-height: 400px">
                        <table
                            id="top-ips-table"
                            class="w-full text-sm text-left text-gray-400"
                        >
                            <thead
                                class="text-xs uppercase bg-gray-700 text-gray-400 sticky top-0"
                            >
                                <tr>
                                    <th class="px-3 py-2">IP Address</th>
                                    <th class="px-3 py-2">Country</th>
                                    <th class="px-3 py-2 text-right">
                                        Requests
                                    </th>
                                    <th class="px-3 py-2 text-center">
                                        Actions
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="top-ips-body">
                                <tr>
                                    <td
                                        colspan="4"
                                        class="px-3 py-4 text-center"
                                    >
                                        Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Request Methods -->
                <div class="bg-gray-800 border border-gray-700 rounded-lg p-5">
                    <h3 class="text-lg font-semibold dark:text-white mb-4">
                        Request Methods
                    </h3>
                    <canvas id="methods-chart"></canvas>
                </div>
            </div>

            {% endif %}
        </div>

        <!-- Scripts -->
        <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

        <script>
            // Get current site slug
            const currentSite = "{{ current_site.slug }}";
            const days = {{ days }};

            // Theme toggle
            const themeToggleBtn = document.getElementById('theme-toggle');
            themeToggleBtn.addEventListener('click', function() {
                document.documentElement.classList.toggle('dark');
            });

            // Site and time range selectors
            document.getElementById('site-selector').addEventListener('change', function() {
                window.location.href = '/analytics/' + this.value + '/?days=' + days;
            });

            document.getElementById('time-range').addEventListener('change', function() {
                window.location.href = '/analytics/' + currentSite + '/?days=' + this.value;
            });

            // Initialize Leaflet Map
            const map = L.map('map', {
                center: [20, 0],
                zoom: 2,
                minZoom: 2,
                maxBounds: [[-90, -180], [90, 180]]
            });

            // Add tile layer (dark mode map)
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
                maxZoom: 19
            }).addTo(map);

            // Fetch and display geographic data
            fetch(`/api/analytics/${currentSite}/geographic/?days=${days}`)
                .then(response => response.json())
                .then(data => {
                    data.data.forEach(location => {
                        const color = location.threat_level === 'critical' ? '#ef4444' :
                                      location.threat_level === 'high' ? '#f97316' : '#10b981';

                        const radius = Math.min(Math.max(location.total_requests / 10, 5), 30);

                        const circle = L.circleMarker([location.lat, location.lng], {
                            radius: radius,
                            fillColor: color,
                            color: color,
                            weight: 1,
                            opacity: 0.8,
                            fillOpacity: 0.5
                        }).addTo(map);

                        // Tooltip on hover
                        circle.bindTooltip(`
                            <div class="text-sm">
                                <strong>${location.country} (${location.country_code})</strong><br>
                                Total Requests: <strong>${location.total_requests}</strong><br>
                                Blocked: <strong class="text-red-400">${location.blocked}</strong><br>
                                Allowed: <strong class="text-green-400">${location.allowed}</strong><br>
                                ${location.critical_threats > 0 ? `Critical Threats: <strong class="text-red-500">${location.critical_threats}</strong><br>` : ''}
                                ${location.high_threats > 0 ? `High Threats: <strong class="text-orange-500">${location.high_threats}</strong>` : ''}
                            </div>
                        `, {
                            permanent: false,
                            direction: 'top'
                        });
                    });
                });

            // Load geographic table
            fetch(`/api/analytics/${currentSite}/table/?days=${days}`)
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('geo-table-body');
                    tbody.innerHTML = '';
                    data.data.forEach(row => {
                        tbody.innerHTML += `
                            <tr class="border-b border-gray-700 hover:bg-gray-700">
                                <td class="px-3 py-2">
                                    <div class="font-medium  dark:text-white ">${row.country}</div>
                                    <div class="text-xs text-gray-400">${row.city}</div>
                                </td>
                                <td class="px-3 py-2 text-right  dark:text-white ">${row.total_requests}</td>
                                <td class="px-3 py-2 text-right ${row.blocked > 0 ? 'text-red-400' : 'text-green-400'}">${row.blocked}</td>
                            </tr>
                        `;
                    });
                });

            // Timeline Chart
            fetch(`/api/analytics/${currentSite}/timeline/?days=${days}`)
                .then(response => response.json())
                .then(data => {
                    const ctx = document.getElementById('timeline-chart').getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.labels,
                            datasets: [
                                {
                                    label: 'Total',
                                    data: data.total,
                                    borderColor: 'rgb(59, 130, 246)',
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                    tension: 0.3
                                },
                                {
                                    label: 'Blocked',
                                    data: data.blocked,
                                    borderColor: 'rgb(239, 68, 68)',
                                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                    tension: 0.3
                                },
                                {
                                    label: 'Allowed',
                                    data: data.allowed,
                                    borderColor: 'rgb(34, 197, 94)',
                                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                    tension: 0.3
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    labels: { color: 'rgb(156, 163, 175)' }
                                }
                            },
                            scales: {
                                y: {
                                    ticks: { color: 'rgb(156, 163, 175)' },
                                    grid: { color: 'rgba(75, 85, 99, 0.3)' }
                                },
                                x: {
                                    ticks: { color: 'rgb(156, 163, 175)' },
                                    grid: { color: 'rgba(75, 85, 99, 0.3)' }
                                }
                            }
                        }
                    });
                });

            // Top IPs Table with Blacklist functionality
            fetch(`/api/analytics/${currentSite}/top-ips/?days=${days}`)
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('top-ips-body');
                    tbody.innerHTML = '';
                    data.data.forEach(row => {
                        tbody.innerHTML += `
                            <tr class="border-b border-gray-700 hover:bg-gray-700">
                                <td class="px-3 py-2  dark:text-white  font-mono">${row.ip}</td>
                                <td class="px-3 py-2 text-gray-400">${row.country}</td>
                                <td class="px-3 py-2 text-right  dark:text-white ">${row.requests}</td>
                                <td class="px-3 py-2 text-center">
                                    ${row.is_blacklisted ?
                                        `<button onclick="removeFromBlacklist('${row.ip}')" class="text-green-400 hover:text-green-300 text-xs">Unblock</button>` :
                                        `<button onclick="blacklistIP('${row.ip}')" class="text-red-400 hover:text-red-300 text-xs">Block</button>`
                                    }
                                </td>
                            </tr>
                        `;
                    });
                });

            // Request Methods Pie Chart
            fetch(`/api/analytics/${currentSite}/methods/?days=${days}`)
                .then(response => response.json())
                .then(data => {
                    const ctx = document.getElementById('methods-chart').getContext('2d');
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: data.labels,
                            datasets: [{
                                data: data.values,
                                backgroundColor: [
                                    'rgb(59, 130, 246)',
                                    'rgb(34, 197, 94)',
                                    'rgb(234, 179, 8)',
                                    'rgb(239, 68, 68)',
                                    'rgb(168, 85, 247)',
                                    'rgb(236, 72, 153)'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: { color: 'rgb(156, 163, 175)' }
                                }
                            }
                        }
                    });
                });

            // Blacklist IP function
            function blacklistIP(ip) {
                if (!confirm(`Are you sure you want to blacklist IP ${ip}?`)) return;

                fetch(`/api/analytics/${currentSite}/blacklist/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ ip_address: ip })
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    location.reload();
                })
                .catch(error => {
                    alert('Error blacklisting IP');
                    console.error(error);
                });
            }

            // Remove from blacklist function
            function removeFromBlacklist(ip) {
                if (!confirm(`Are you sure you want to remove IP ${ip} from blacklist?`)) return;

                fetch(`/api/analytics/${currentSite}/unblacklist/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ ip_address: ip })
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    location.reload();
                })
                .catch(error => {
                    alert('Error removing IP from blacklist');
                    console.error(error);
                });
            }
        </script>
    </body>
</html>
doctype
         /
         /










                <style>
            #map {
                height: 500px;
                border-radius: 0.5rem;
            }
        </style>
    </head>
    <body class="bg-gray-900">
        <!-- Navigation Bar -->
        <nav class="bg-gray-800 border-b border-gray-700">
            <div
                class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4"
            >
                <a
                    href="/"
                    class="flex items-center space-x-3 rtl:space-x-reverse"
                >
                    <svg
                        class="w-8 h-8 text-blue-500"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"
                        ></path>
                    <span
                        class="self-center text-2xl font-semibold whitespace-nowrap dark:text-white"
                        >WAF Analytics</span
                    >
                </a>
                <div class="flex items-center space-x-4">
                    <button
                        id="theme-toggle"
                        type="button"
                        class="text-gray-400 hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-700 rounded-lg text-sm p-2.5"
                    >
                        <svg
                            id="theme-toggle-dark-icon"
                            class="w-5 h-5"
                            fill="currentColor"
                            viewBox="0 0 20 20"
                        >
                            <path
                                d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
                            ></path>
                        </svg>
                    </button>
nav        <div class="max-w-screen-xl mx-auto p-4">
            {% if error %}
            <div
                class="p-4 mb-4 text-sm text-red-800 rounded-lg bg-red-50 dark:bg-gray-800 dark:text-red-400"
                role="alert"
            >
                {{ error }}
            {% else %}
            <!-- Header with Site Selector and Time Range -->
            <div
                class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4"
            >
                <div>
                    <h1 class="text-3xl font-bold dark:text-white mb-2">
                        Analytics Dashboard
                    </h1>
                    <p class="text-gray-400">
                        Geographic request analytics and threat monitoring
                    </p>
                <div class="flex gap-3">
                    <!-- Site Selector -->
                    <select
                        id="site-selector"
                        class="bg-gray-700 border border-gray-600 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5"
                    >
                        {% for site in sites %}
                        <option
                            value="{{ site.slug }}"
                            {%
                            if
                            site=""
                            ="current_site"
                            %}selected{%
                            endif
                            %}
                        >

                     value="{{ site.slug }}"
                            {%
                            if
                            site=""
                            ="current_site"
                            %}selected{%
                            endif
                            %}
                        >
                            {{ site.host }}
                        </option>
                        {% endfor %}
                    </select>
                    <!-- Time Range Selector -->
                    <select
                        id="time-range"
                        class="bg-gray-700 border border-gray-600 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5"
                    >
                        <option
                            value="1"
                            {%
                            if
                            days=""
                            ="1"
                            %}selected{%
                            endif
                            %}
                        >
                            value="1"
                            {%
                            if
                            days=""
                            ="1"
                            %}selected{%
                            endif
                            %}
                        >
                            Last 24 Hours
                        </option>
                        <option
                            value="7"
                            {%
                            if
                            days=""
                            ="7"
                            %}selected{%
                            endif
                            %}
                        >
                            value="7"
                            {%
                            if
                            days=""
                            ="7"
                            %}selected{%
                            endif
                            %}
                        >
                            Last 7 Days
                        </option>
                        <option
                            value="30"
                            {%
                            if
                            days=""
                            ="30"
                            %}selected{%
                            endif
                            %}
                        >
                            value="30"
                            {%
                            if
                            days=""
                            ="30"
                            %}selected{%
                            endif
                            %}
                        >
                            Last 30 Days
                        </option>
                        <option
                            value="90"
                            {%
                            if
                            days=""
                            ="90"
                            %}selected{%
                            endif
                            %}
                        >
                            value="90"
                            {%
                            if
                            days=""
                            ="90"
                            %}selected{%
                            endif
                            %}
                        >
                            Last 90 Days
                        </option>
                    </select>
                    <!-- Export Dropdown -->
                    <button
                        id="dropdownExportButton"
                        data-dropdown-toggle="dropdownExport"
                        class="dark:text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center inline-flex items-center"
                        type="button"
                    >
                        Export
                        <svg
                            class="w-2.5 h-2.5 ms-3"
                            aria-hidden="true"
                            xmlns="http://www.w3.org/2000/svg"
                            fill="none"
                            viewBox="0 0 10 6"
                        >
                            <path
                                stroke="currentColor"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="m1 1 4 4 4-4"
                            />
                        </svg>
                    </button>
                    <div
                        id="dropdownExport"
                        class="z-10 hidden bg-gray-700 divide-y divide-gray-600 rounded-lg shadow w-44"
                    >
                        <ul
                            class="py-2 text-sm text-gray-200"
                            aria-labelledby="dropdownExportButton"
                        >
                            <li>
                                <a
                                    href="{% url 'export_csv' current_site.slug %}?days={{ days }}"
                                    class="block px-4 py-2 hover:bg-gray-600"
                                    >Export CSV</a
                                >
                            </li>
                            <li>
                                <a
                                    href="{% url 'export_json' current_site.slug %}?days={{ days }}"
                                    class="block px-4 py-2 hover:bg-gray-600"
                                    >Export JSON</a
                                >
                            </li>
                        </ul>
            <!-- Key Metrics Cards -->
            <div
                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6"
            >
                <!-- Total Requests -->
                <div class="bg-gray-800 border border-gray-700 rounded-lg p-5">
                    <div class="flex items-center justify-between mb-2">
                        <h5 class="text-sm font-medium text-gray-400">
                            Total Requests
                        </h5>
                        <svg
                            class="w-5 h-5 text-blue-500"
                            fill="currentColor"
                            viewBox="0 0 20 20"
                        >
                            <path
                                d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"
                            ></path>
                        </svg>
                    </div>
                    <p class="text-3xl font-bold dark:text-white">
                        {{ total_requests|default:"0" }}
                    </p>
                </div>

                <!-- Blocked Requests -->
                <div class="bg-gray-800 border border-gray-700 rounded-lg p-5">
                    <div class="flex items-center justify-between mb-2">
                        <h5 class="text-sm font-medium text-gray-400">
                            Blocked
                        </h5>
                        <svg
                            class="w-5 h-5 text-red-500"
                            fill="currentColor"
                            viewBox="0 0 20 20"
                        >
                            <path
                                fill-rule="evenodd"
                                d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z"
                                clip-rule="evenodd"
                            ></path>
                        </svg>
                    </div>
                    <p class="text-3xl font-bold dark:text-white">
                        {{ blocked_requests|default:"0" }}
                    </p>
                    <p class="text-sm text-gray-400">
                        {{ blocked_percentage|floatformat:1 }}%
                    </p>
                </div>

                <!-- Unique Countries -->
                <div class="bg-gray-800 border border-gray-700 rounded-lg p-5">
                    <div class="flex items-center justify-between mb-2">
                        <h5 class="text-sm font-medium text-gray-400">
                            Countries
                        </h5>
                        <svg
                            class="w-5 h-5 text-green-500"
                            fill="currentColor"
                            viewBox="0 0 20 20"
                        >
                            <path
                                fill-rule="evenodd"
                                d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.73 6.974 6 7.5 6A1.5 1.5 0 019 7.5V8a2 2 0 004 0 2 2 0 011.523-1.943A5.977 5.977 0 0116 10c0 .34-.028.675-.083 1H15a2 2 0 00-2 2v2.197A5.973 5.973 0 0110 16v-2a2 2 0 00-2-2 2 2 0 01-2-2 2 2 0 00-1.668-1.973z"
                                clip-rule="evenodd"
                            ></path>
                        </svg>
                    </div>
                    <p class="text-3xl font-bold dark:text-white">
                        {{ unique_countries|default:"0" }}
                    </p>
                </div>

                <!-- Unique IPs -->
                <div class="bg-gray-800 border border-gray-700 rounded-lg p-5">
                    <div class="flex items-center justify-between mb-2">
                        <h5 class="text-sm font-medium text-gray-400">
                            Unique IPs
                        </h5>
                        <svg
                            class="w-5 h-5 text-yellow-500"
                            fill="currentColor"
                            viewBox="0 0 20 20"
                        >
                            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path>
                            <path
                                fill-rule="evenodd"
                                d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z"
                                clip-rule="evenodd"
                            ></path>
                        </svg>
                    </div>
                    <p class="text-3xl font-bold dark:text-white">
                        {{ unique_ips|default:"0" }}
                    </p>
                </div>

                <!-- Avg Response Time -->
                <div class="bg-gray-800 border border-gray-700 rounded-lg p-5">
                    <div class="flex items-center justify-between mb-2">
                        <h5 class="text-sm font-medium text-gray-400">
                            Avg Response
                        </h5>
                        <svg
                            class="w-5 h-5 text-purple-500"
                            fill="currentColor"
                            viewBox="0 0 20 20"
                        >
                            <path
                                fill-rule="evenodd"
                                d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"
                                clip-rule="evenodd"
                            ></path>
                        </svg>
                    </div>
                    <p class="text-3xl font-bold dark:text-white">
                        {{ avg_response_time|default:"0" }}
                    </p>
                    <p class="text-sm text-gray-400">ms</p>
                </div>

            <!-- Threat Alerts -->
            {% if recent_alerts %}
            <div class="mb-6 bg-gray-800 border border-gray-700 rounded-lg p-5">
                <h3
                    class="text-lg font-semibold dark:text-white mb-4 flex items-center"
                >
                    <svg
                        class="w-5 h-5 mr-2 text-red-500"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                    >
                        <path
                            fill-rule="evenodd"
                            d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                            clip-rule="evenodd"
                        ></path>
                    </svg>
                    Active Threat Alerts
                </h3>
                <div class="space-y-2">
                    {% for alert in recent_alerts %}
                    <div
                        class="flex items-center justify-between p-3 bg-gray-700 rounded-lg"
                    >
                        <div class="flex items-center gap-3">
                            <span
                                class="px-2 py-1 text-xs font-medium rounded {% if alert.severity == 'critical' %}bg-red-900 text-red-300 {% elif alert.severity == 'high' %}bg-orange-900 text-orange-300 {% else %}bg-yellow-900 text-yellow-300{% endif %}"
                            >
                                {{ alert.severity|upper }}
                            </span>
                            <span class="dark:text-white"
                                >{{ alert.get_alert_type_display }}</span
                            >
                            {% if alert.ip_address %}
                            <span class="text-gray-400"
                                >{{ alert.ip_address }}</span
                            >
                            {% endif %} {% if alert.country_code %}
                            <span class="text-gray-400"
                                >{{ alert.country_code }}</span
                            >
                            {% endif %}
                        </div>
                        <span class="text-sm text-gray-400"
                            >{{ alert.timestamp|timesince }} ago</span
                        >
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Main Content: Map and Geographic Table -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <!-- 2D World Map -->
                <div
                    class="lg:col-span-2 bg-gray-800 border border-gray-700 rounded-lg p-5"
                >
                    <h3 class="text-lg font-semibold dark:text-white mb-4">
                        Geographic Distribution
                    </h3>
                    <div id="map"></div>
                </div>

                <!-- Geographic Breakdown Table -->
                <div class="bg-gray-800 border border-gray-700 rounded-lg p-5">
                    <h3 class="text-lg font-semibold dark:text-white mb-4">
                        Top Locations
                    </h3>
                    <div class="overflow-auto" style="max-height: 500px">
                        <table
                            id="geo-table"
                            class="w-full text-sm text-left text-gray-400"
                        >
                            <thead
                                class="text-xs uppercase bg-gray-700 text-gray-400 sticky top-0"
                            >
                                <tr>
                                    <th class="px-3 py-2">Location</th>
                                    <th class="px-3 py-2 text-right">
                                        Requests
                                    </th>
                                    <th class="px-3 py-2 text-right">
                                        Blocked
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="geo-table-body">
                                <tr>
                                    <td
                                        colspan="3"
                                        class="px-3 py-4 text-center"
                                    >
                                        Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Timeline Chart -->
            <div class="mb-6 bg-gray-800 border border-gray-700 rounded-lg p-5">
                <h3 class="text-lg font-semibold dark:text-white mb-4">
                    Requests Over Time
                </h3>
                <canvas id="timeline-chart" height="80"></canvas>
            </div>

            <!-- Bottom Row: Top IPs and Request Methods -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Top IPs -->
                <div class="bg-gray-800 border border-gray-700 rounded-lg p-5">
                    <h3 class="text-lg font-semibold dark:text-white mb-4">
                        Top Requesting IPs
                    </h3>
                    <div class="overflow-auto" style="max-height: 400px">
                        <table
                            id="top-ips-table"
                            class="w-full text-sm text-left text-gray-400"
                        >
                            <thead
                                class="text-xs uppercase bg-gray-700 text-gray-400 sticky top-0"
                            >
                                <tr>
                                    <th class="px-3 py-2">IP Address</th>
                                    <th class="px-3 py-2">Country</th>
                                    <th class="px-3 py-2 text-right">
                                        Requests
                                    </th>
                                    <th class="px-3 py-2 text-center">
                                        Actions
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="top-ips-body">
                                <tr>
                                    <td
                                        colspan="4"
                                        class="px-3 py-4 text-center"
                                    >
                                        Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Request Methods -->
                <div class="bg-gray-800 border border-gray-700 rounded-lg p-5">
                    <h3 class="text-lg font-semibold dark:text-white mb-4">
                        Request Methods
                    </h3>
                    <canvas id="methods-chart"></canvas>
                </div>
            </div>

            {% endif %}
<!--Scripts-->
        <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js">script>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script        >
            Get current site slug
            const currentSite  {{ current_site.slug|default'' }};
            const days = {{ days|default:7 }};            Themetoggle
            themeToggleBtndocumentgetElementById('theme-toggle')
            if(themeToggleBtn){
                themeToggleBtn.addEventListener('click',function(){
                    document.documentElement.classList.toggle('dark')
                });
            }            // Site and time range selectors
            const siteSelector = document.getElementById('site-selector');
            if (siteSelector) {
                siteSelector.addEventListener('change', function() {
                    const selectedSlug = this.value;
                    if (selectedSlug) {
                        window.location.href = '/analytics/' + selectedSlug + '/?days=' + days;
                    }
                });
            }
            const timeRangeSelector = document.getElementById('time-range');
            if (timeRangeSelector) {
                timeRangeSelector.addEventListener('change', function() {
                    const selectedDays = this.value;
                    if (currentSite) {
                        window.location.href = '/analytics/' + currentSite + '/?days=' + selectedDays;
                    }
                });
            }
            // Only initialize charts if we have a valid site
            if (!currentSite) {
                console.error('No site selected');
            } else {
                // Initialize Leaflet Map
                const map = L.map('map', {
                    center: [20, 0],
                    zoom: 2,
                    minZoom: 2,
                    maxBounds: [[-90, -180], [90, 180]]
                });
                // Add tile layer (dark mode map)
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
                    maxZoom: 19
                }).addTo(map);
                // Fetch and display geographic data
                fetch(`/api/analytics/${currentSite}/geographic/?days=${days}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.data && data.data.length > 0) {
                            data.data.forEach(location => {
                                const color = location.threat_level === 'critical' ? '#ef4444' :
                                              location.threat_level === 'high' ? '#f97316' : '#10b981';
                                const radius = Math.min(Math.max(location.total_requests / 10, 5), 30);
                                circleLcircleMarker[latlocation.lng], {
                                    radius: radius,
                                    fillColor: color,
                                    color: color,
                                    weight: 1,
                                    opacity: 0.8,
                                    fillOpacity: 0.
                                }.addTo(map                                // Tooltip on hover
                                circle.bindTooltip(`
                                    <div class="text-sm">
                                        <strong>${location.country} (${location.country_code})</strong><br>
                                        Total Requests: <strong>${location.total_requests}</strong><br>
                                        Blocked: <strong class="text-red-400">${location.blocked}</strong><br>
                                        Allowed: <strong class="text-green-400">${location.allowed}</strong><br>
                                        ${location.critical_threats > 0 ? `Critical Threats: <strong class="text-red-500">${location.critical_threats}</strong><br>` : ''}
                                        ${location.high_threats > 0 ? `High Threats: <strong class="text-orange-500">${location.high_threats}</strong>` : ''}
                                    </div>
                                `, {
                                    permanent: false,
                                    direction: 'top'
                                });
                    })
                    .catch(error => console.error('Error loading geographic data:', error));

                // Load geographic table
                fetch(`/api/analytics/${currentSite}/table/?days=${days}`)
                    .then(response => response.json())
                    .then(data => {
                        const tbody = document.getElementById('geo-table-body');
                        tbody.innerHTML = '';
                        if (data.data && data.data.length > 0) {
                            data.data.forEach(row => {
                                tbody.innerHTML += `
                                    <tr class="border-b border-gray-700 hover:bg-gray-700">
                                        <td class="px-3 py-2">
                                            <div class="font-medium dark:text-white">${row.country}</div>
                                            <div class="text-xs text-gray-400">${row.city}</div>
                                        </td>
                                        <td class="px-3 py-2 text-right dark:text-white">${row.total_requests}</td>
                                        <td class="px-3 py-2 text-right ${row.blocked > 0 ? 'text-red-400' : 'text-green-400'}">${row.blocked}</td>
                                    </tr>
                                `;
                            });
                        } else {
                            tbody.innerHTML = '<tr><td colspan="3" class="px-3 py-4 text-center">No data available</td></tr>';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading table data:', error);
                        document.getElementById('geo-table-body').innerHTML = '<tr><td colspan="3" class="px-3 py-4 text-center text-red-400">Error loading data</td></tr>';
                // Timeline Chart
                fetch(`/api/analytics/${currentSite}/timeline/?days=${days}`)
                    .then(response => response.json())
                    .then(data => {
                        const ctx = document.getElementById('timeline-chart').getContext('2d');
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: data.labels,
                                datasets: [
                                    {
                                        label: 'Total',
                                        data: data.total,
                                        borderColor: 'rgb(59, 130, 246)',
                                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                        tension: 0.3
                                    },
                                    {
                                        label: 'Blocked',
                                        data: data.blocked,
                                        borderColor: 'rgb(239, 68, 68)',
                                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                        tension: 0.3
                                    },
                                    {
                                        label: 'Allowed',
                                        data: data.allowed,
                                        borderColor: 'rgb(34, 197, 94)',
                                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                        tension: 0.3
                                    }
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                plugins: {
                                    legend: {
                                        labels: { color: 'rgb(156, 163, 175)' }
                                    }
                                },
                                scales: {
                                    y: {
                                        ticks: { color: 'rgb(156, 163, 175)' },
                                        grid: { color: 'rgba(75, 85, 99, 0.3)' }
                                    },
                                    x: {
                                        ticks: { color: 'rgb(156, 163, 175)' },
                                        grid: { color: 'rgba(75, 85, 99, 0.3)' }
                                    }
                        });
                    })
                    .catch(error => console.error('Error loading timeline data:', error));

                // Top IPs Table with Blacklist functionality
                fetch(`/api/analytics/${currentSite}/top-ips/?days=${days}`)
                    .then(response => response.json())
                    .then(data => {
                        const tbody = document.getElementById('top-ips-body');
                        tbody.innerHTML = '';
                        if (data.data && data.data.length > 0) {
                            data.data.forEach(row => {
                                tbody.innerHTML += `
                                    <tr class="border-b border-gray-700 hover:bg-gray-700">
                                        <td class="px-3 py-2 dark:text-white font-mono">${row.ip}</td>
                                        <td class="px-3 py-2 text-gray-400">${row.country}</td>
                                        <td class="px-3 py-2 text-right dark:text-white">${row.requests}</td>
                                        <td class="px-3 py-2 text-center">
                                            ${row.is_blacklisted ?
                                                `<button onclick="removeFromBlacklist('${row.ip}')" class="text-green-400 hover:text-green-300 text-xs">Unblock</button>` :
                                                `<button onclick="blacklistIP('${row.ip}')" class="text-red-400 hover:text-red-300 text-xs">Block</button>`
                                            }
                                        </td>
                                    </tr>
                                `;
                            });
                        } else {
                            tbody.innerHTML = '<tr><td colspan="4" class="px-3 py-4 text-center">No data available</td></tr>';
                    })
                    .catch(error => {
                        console.error('Error loading IP data:', error);
                        document.getElementById('top-ips-body').innerHTML = '<tr><td colspan="4" class="px-3 py-4 text-center text-red-400">Error loading data</td></tr>';

                // Request Methods Pie Chart
                fetch(`/api/analytics/${currentSite}/methods/?days=${days}`)
                    .then(response => response.json())
                    .then(data => {
                        const ctx = document.getElementById('methods-chart').getContext('2d');
                        new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: data.labels,
                                datasets: [{
                                    data: data.values,
                                    backgroundColor: [
                                        'rgb(59, 130, 246)',
                                        'rgb(34, 197, 94)',
                                        'rgb(234, 179, 8)',
                                        'rgb(239, 68, 68)',
                                        'rgb(168, 85, 247)',
                                        'rgb(236, 72, 153)'
                                    ]
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                plugins: {
                                    legend: {
                                        position: 'bottom',
                                        labels: { color: 'rgb(156, 163, 175)' }
                                    }
                                }
                            }
                        });
                    })
                    .catch(error => console.error('Error loading methods data:', error));
            }

            // Blacklist IP function
            function blacklistIP(ip) {
                if (!confirm(`Are you sure you want to blacklist IP ${ip}?`)) return;

                fetch(`/api/analytics/${currentSite}/blacklist/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ ip_address: ip })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    location.reload();
                })
                .catch(error => {
                    alert('Error blacklisting IP');
                    console.error(error);
                });
            }
            Removefrom blacklist
            removeFromBlacklist
                remove from blacklist                fetch(`/api/analytics/${currentSite}/unblacklist/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ ip_address: ip })
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    location.reload();
                })
                .catch(error => {
                    alert('Error removing IP from blacklist');
                    console.error(error);
                });
            }
        </script>
    </body>



            ""



    >











                                    <option
                        value="{{ site.slug }}"
                        {%
                        if
                        site=""
                        ="current_site"
                        %}selected{%
                        endif
                        %}
                    >

                  value="{{ site.slug }}"
                        {%
                        if
                        site=""
                        ="current_site"
                        %}selected{%
                        endif
                        %}
                    >
                        {{ site.host }}
                    </option>
                <label for="time-range" class="sr-only"
                    >Choose time range</label
                >
                <select
                    id="time-range"
                    class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                >
                    <option value="1" {% if days=""=""=""="" ="="="="1"""" %}selected{% endif %}>
                        Last 24 Hours
                    </option>
                    <option value="7" {% if days=""=""=""="" ="="="="7"""" %}selected{% endif %}>
                        Last 7 Days
                    </option>
                    <option
                        value="30"
                        {%
                        if
                        days=""
                        ="30"
                        %}selected{%
                        endif
                        %}
                    >
                        Last 30 Days
                    </option>
                    <option
                        value="90"
                        {%
                        if
                        days=""
                        ="90"
                        %}selected{%
                        endif
                        %}
                    >
                        Last 90 Days
                    </option>





                            <svg
                    class="w-2.5 h-2.5 ms-3"
                    aria-hidden="true"
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 10 6"
                >
                    <path
                        stroke="currentColor"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="m1 1 4 4 4-4"
                    />
            <div
                id="dropdownExport"
                class="z-10 hidden bg-white divide-y divide-gray-100 rounded-lg shadow w-44 dark:bg-gray-700"
            >
                <ul
                    class="py-2 text-sm text-gray-700 dark:text-gray-200"
                    aria-labelledby="dropdownExportButton"
                >
                    <li>
                        <a
                            href="{% url 'export_csv' current_site.slug %}?days={{ days }}"
                            class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white"
                            >Export CSV</a
                        >
                    </li>
                    <li>
                        <a
                            href="{% url 'export_json' current_site.slug %}?days={{ days }}"
                            class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white"
                            >Export JSON</a
                        >
                    </li>


                <h5 class="text-sm font-medium text-gray-500 dark:text-gray-400">
                Total Requests
            </h5>
            <svg
                class="w-5 h-5 text-blue-500"
                fill="currentColor"
                viewBox="0 0 20 20"
            >
                <path
                    d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"
                ></path>




                <h5 class="text-sm font-medium text-gray-500 dark:text-gray-400">
                Blocked
            </h5>
            <svg
                class="w-5 h-5 text-red-500"
                fill="currentColor"
                viewBox="0 0 20 20"
            >
                <path
                    fill-rule="evenodd"
                    d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z"
                    clip-rule="evenodd"
                ></path>






                <h5 class="text-sm font-medium text-gray-500 dark:text-gray-400">
                Countries
            </h5>
            <svg
                class="w-5 h-5 text-green-500"
                fill="currentColor"
                viewBox="0 0 20 20"
            >
                <path
                    fill-rule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.73 6.974 6 7.5 6A1.5 1.5 0 019 7.5V8a2 2 0 004 0 2 2 0 011.523-1.943A5.977 5.977 0 0116 10c0 .34-.028.675-.083 1H15a2 2 0 00-2 2v2.197A5.973 5.973 0 0110 16v-2a2 2 0 00-2-2 2 2 0 01-2-2 2 2 0 00-1.668-1.973z"
                    clip-rule="evenodd"
                ></path>


















                <h5 class="text-sm font-medium text-gray-500 dark:text-gray-400">
                Avg Response
            </h5>
            <svg
                class="w-5 h-5 text-purple-500"
                fill="currentColor"
                viewBox="0 0 20 20"
            >
                <path
                    fill-rule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"
                    clip-rule="evenodd"
                ></path>


        <div
    class="mb-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-5 shadow-sm"
>
    <h3
        class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center"
    >
        <svg
            class="w-5 h-5 mr-2 text-red-500"
            fill="currentColor"
            viewBox="0 0 20 20"
        >
            <path
                fill-rule="evenodd"
                d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                clip-rule="evenodd"
            ></path>












                <div
        class="lg:col-span-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-5 shadow-sm"
    >
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
            Geographic Distribution
        </h3>
        <div
            id="map-loading"
            class="flex items-center justify-center h-[500px]"
        >
                <svg
                    aria-hidden="true"
                    class="w-8 h-8 text-gray-200 animate-spin dark:text-gray-600 fill-blue-600"
                    viewBox="0 0 100 101"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                >
                    <path
                        d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z"
                        fill="currentColor"
                    />
                    <path
                        d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z"
                        fill="currentFill"
                    />
    <div
        class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-5 shadow-sm"
    >
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
            Top Locations
        </h3>
        <div class="overflow-auto" style="max-height: 500px">
            <table
                class="w-full text-sm text-left text-gray-500 dark:text-gray-400"
            >
                <thead
                    class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400 sticky top-0"
                >












        <div
        class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-5 shadow-sm"
    >
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
            Top Requesting IPs
        </h3>
        <div class="overflow-auto" style="max-height: 400px">
            <table
                class="w-full text-sm text-left text-gray-500 dark:text-gray-400"
            >
                <thead
                    class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400 sticky top-0"
                >












            "" """"""""""""""""""
                    ""

                    ""
                    """"""""""""(()"""""""""","" "" "" "" "" "","""" """" (

                                ""

                                ""
                                ""
                                ""
                            )

                                ""

                                  ""

                                    ""
                                    ""

                                ""

                                  ""

                                    ""
                                    ""                        return (
                            '<div class="hoverinfo" style="padding: 8px;">' +
                            '<strong style="font-size: 14px; color: #60a5fa;">' +
                            data.country +
                            "</strong><br><br>" +
                            '<div style="margin: 4px 0;"><span style="color: #9ca3af;">Total Requests:</span> <strong style="color: #60a5fa;">' +
                            data.total_requests.toLocaleString() +
                            "</strong></div>" +
                            '<div style="margin: 4px 0;"><span style="color: #9ca3af;">Blocked:</span> <strong style="color: #ef4444;">' +
                            data.blocked.toLocaleString() +
                            "</strong></div>" +
                            '<div style="margin: 4px 0;"><span style="color: #9ca3af;">Allowed:</span> <strong style="color: #10b981;">' +
                            data.allowed.toLocaleString() +
                            "</strong></div>" +
                            '<div style="margin: 4px 0;"><span style="color: #9ca3af;">Threat Level:</span> <strong style="color: ' +
                            threatColor +
                            ';">' +
                            threatLevel +
                            "</strong></div>" +
                            "</div>"
                        );
                    },
                     datamap.svg
                        .selectAll(".datamaps-subunit")
                        .on("click", function (geography) {
                            const countryCode = geography.id;
                            const data = countryData[countryCode];
                            if (data) {
                                console.log(
                                    "Clicked country:",
                                    data.country,
                                    data,
                                );
                            }
                        });
                },
""
                ""

                "",
            """"
                    """"""""
                    """"(()(()(()
                ""),
            )(()(()""""(()""""
                        (()""""
                    (()(()
                    ""
                    """""""""","""""","""""",,,"",,"""","""",,,,(()
                ""),
            )(()(()""""(()                                    ${
                                        row.is_blacklisted
                                            ? `<button onclick="removeFromBlacklist('${row.ip}')" class="text-green-600 hover:text-green-700 dark:text-green-400 dark:hover:text-green-300 text-xs font-medium">Unblock</button>`
                                            : `<button onclick="blacklistIP('${row.ip}')" class="text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 text-xs font-medium">Block</button>`

                        (()""""
                    (()(()
                    ""
                    """"                        datasets: [
                            {
                                data: data.values,
                                backgroundColor: [
                                    "rgb(59, 130, 246)",
                                    "rgb(34, 197, 94)",
                                    "rgb(234, 179, 8)",
                                    "rgb(239, 68, 68)",
                                    "rgb(168, 85, 247)",
                                    "rgb(236, 72, 153)",
                                ],
                            },
                        ],
"""",,,,(()
                ""),
            )
                """""""""",,                .then((response) => response.json())
                .then((data) => {
                    alert(data.message);
                    location.reload();
                })
                .catch((error) => {
                    alert("Error blacklisting IP");
                    console.error(error);
                });


                    ,
                )
            )
                """""""""",,                .then((response) => response.json())
                .then((data) => {
                    alert(data.message);
                    location.reload();
                })
                .catch((error) => {
                    alert("Error removing IP from blacklist");
                    console.error(error);
                });
